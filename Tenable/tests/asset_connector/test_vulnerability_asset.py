import pytest
from unittest.mock import patch, Mock

from sekoia_automation.asset_connector.models.ocsf.vulnerability import VulnerabilityOCSFModel
from sekoia_automation.asset_connector.models.ocsf.device import (
    DeviceTypeStr,
    DeviceTypeId,
    OSTypeStr,
    OSTypeId,
    NetworkInterfaceTypeStr,
    NetworkInterfaceTypeId,
)
from tenable.io.exports.api import ExportsAPI

from tenable_conn.asset_connector.vulnerability_asset import (
    TenableAssetConnector,
    VulnerabilityState,
    VulnerabilitySeverity,
)
from tenable_conn import TenableModule


@pytest.fixture
def asset_info():
    return {
        "name": "moxptgljp3d450f5.example.demo",
        "id": "74a507c2-c885-41ee-a34d-e151c99e3f60",
        "has_agent": False,
        "created_at": "2025-08-26T14:34:38.571Z",
        "updated_at": "2025-08-26T14:34:38.000Z",
        "terminated_at": None,
        "deleted_at": None,
        "aes_score_v3": None,
        "acr_score_v3": "one",
        "first_seen": "2025-08-26T14:34:38.000Z",
        "last_seen": "2025-08-26T14:34:38.571Z",
        "last_scan_target": "97.195.198.2",
        "last_authentication_attempt_date": None,
        "last_authentication_success_date": None,
        "last_authenticated_scan_date": "2025-08-26T14:34:38.571Z",
        "last_licensed_scan_date": "2025-08-26T14:34:38.571Z",
        "last_scan_id": "3427421a-9476-e291-686f-8d60d7fc401892fd2478c88003fc",
        "last_schedule_id": "1c12e931-8a64-443e-9b0e-382c1ea32b70",
        "sources": [
            {"name": "NESSUS_SCAN", "first_seen": "2025-08-26T14:34:38.571Z", "last_seen": "2025-08-26T14:34:38.571Z"}
        ],
        "tags": [],
        "acr_score": None,
        "acr_drivers": None,
        "exposure_score": None,
        "scan_frequency": None,
        "interfaces": [
            {
                "ipv4": ["97.195.198.2"],
                "ipv6": [],
                "fqdn": ["moxptgljp3d450f5.example.demo"],
                "mac_address": ["00:00:00:58:7d:4b"],
                "name": "CATCH_ALL_INTERFACE",
                "virtual": None,
                "aliased": None,
            }
        ],
        "network_id": ["00000000-0000-0000-0000-000000000000"],
        "ipv4": ["97.195.198.2"],
        "ipv6": [],
        "fqdn": ["moxptgljp3d450f5.example.demo"],
        "mac_address": ["00:00:00:58:7d:4b"],
        "netbios_name": [],
        "operating_system": ["Solaris 10 (sparc)"],
        "system_type": ["general-purpose"],
        "tenable_uuid": ["103a8272187f4f0491c614fa8df962db"],
        "hostname": ["moxptgljp3d450f5.example.demo"],
        "agent_name": [],
        "bios_uuid": [],
        "aws_ec2_instance_id": [],
        "aws_ec2_instance_ami_id": [],
        "aws_owner_id": [],
        "aws_availability_zone": [],
        "aws_region": [],
        "aws_vpc_id": [],
        "aws_ec2_instance_group_name": [],
        "aws_ec2_instance_state_name": [],
        "aws_ec2_instance_type": [],
        "aws_subnet_id": [],
        "aws_ec2_product_code": [],
        "aws_ec2_name": [],
        "azure_vm_id": [],
        "azure_resource_id": [],
        "azure_subscription_id": [],
        "azure_resource_group": [],
        "azure_location": [],
        "azure_type": [],
        "gcp_project_id": [],
        "gcp_zone": [],
        "gcp_instance_id": [],
        "ssh_fingerprint": [],
        "mcafee_epo_guid": [],
        "mcafee_epo_agent_guid": [],
        "qualys_asset_id": [],
        "qualys_host_id": [],
        "servicenow_sysid": [],
        "installed_software": [],
        "bigfix_asset_id": [],
        "security_protection_level": None,
        "security_protections": [],
        "exposure_confidence_value": None,
    }


@pytest.fixture
def vulnerability():
    return {
        "asset": {
            "agent_uuid": "45bd0c2b59f347e49be93442699f4845",
            "device_type": "general-purpose",
            "fqdn": "s4r5r1zrzdbdxs0w.example.demo",
            "hostname": "s4r5r1zrzdbdxs0w.example.demo",
            "uuid": "d3fb3e2e-2f4a-4f4b-8f4a-1e2b3c4d5e6f",
        },
        "output": "\nRemote package installed : bind-libs-9.9.4-61.el7\nShould be                : bind-libs-9.9.4-74.el7_6.1\n\nRemote package installed : bind-license-9.9.4-61.el7\nShould be                : bind-license-9.9.4-74.el7_6.1\n\nRemote package installed : bind-utils-9.9.4-61.el7\nShould be                : bind-utils-9.9.4-74.el7_6.1\n\n",
        "plugin": {
            "bid": [125801],
            "checks_for_default_account": False,
            "checks_for_malware": False,
            "cpe": [
                "p-cpe:/a:centos:centos:bind-pkcs11",
                "p-cpe:/a:centos:centos:bind-pkcs11-utils",
                "cpe:/o:centos:centos:7",
                "p-cpe:/a:centos:centos:bind-license",
                "p-cpe:/a:centos:centos:bind-utils",
                "p-cpe:/a:centos:centos:bind-pkcs11-devel",
                "p-cpe:/a:centos:centos:bind-sdb-chroot",
                "p-cpe:/a:centos:centos:bind-devel",
                "p-cpe:/a:centos:centos:bind-libs-lite",
                "p-cpe:/a:centos:centos:bind",
                "p-cpe:/a:centos:centos:bind-sdb",
                "p-cpe:/a:centos:centos:bind-chroot",
                "p-cpe:/a:centos:centos:bind-lite-devel",
                "p-cpe:/a:centos:centos:bind-libs",
                "p-cpe:/a:centos:centos:bind-pkcs11-libs",
            ],
            "cvss3_base_score": 7.5,
            "cvss3_temporal_score": 6.5,
            "cvss3_temporal_vector": {
                "exploitability": "Unproven",
                "remediation_level": "Official Fix",
                "report_confidence": "Confirmed",
                "raw": "E:U/RL:O/RC:C",
            },
            "cvss3_vector": {
                "access_complexity": "Low",
                "access_vector": "Network",
                "availability_impact": "High",
                "confidentiality_impact": "None",
                "integrity_impact": "None",
                "raw": "AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
            },
            "cvss_base_score": 4.3,
            "cvss_temporal_score": 3.2,
            "cvss_temporal_vector": {
                "exploitability": "Unproven",
                "remediation_level": "Official Fix",
                "report_confidence": "Confirmed",
                "raw": "E:U/RL:OF/RC:C",
            },
            "cvss_vector": {
                "access_complexity": "Medium",
                "access_vector": "Network",
                "authentication": "None required",
                "availability_impact": "Partial",
                "confidentiality_impact": "None",
                "integrity_impact": "None",
                "raw": "AV:N/AC:M/Au:N/C:N/I:N/A:P",
            },
            "description": "An update for bind is now available for Red Hat Enterprise Linux 7.\n\nRed Hat Product Security has rated this update as having a security impact of Important. A Common Vulnerability Scoring System (CVSS) base score, which gives a detailed severity rating, is available for each vulnerability from the CVE link(s) in the References section.\n\nThe Berkeley Internet Name Domain (BIND) is an implementation of the Domain Name System (DNS) protocols. BIND includes a DNS server (named); a resolver library (routines for applications to use when interfacing with DNS); and tools for verifying that the DNS server is operating correctly.\n\nSecurity Fix(es) :\n\n* bind: Limiting simultaneous TCP clients is ineffective (CVE-2018-5743)\n\nFor more details about the security issue(s), including the impact, a CVSS score, acknowledgments, and other related information, refer to the CVE page(s) listed in the References section.",
            "exploit_available": False,
            "exploit_framework_canvas": False,
            "exploit_framework_core": False,
            "exploit_framework_d2_elliot": False,
            "exploit_framework_exploithub": False,
            "exploit_framework_metasploit": False,
            "exploitability_ease": "No known exploits are available",
            "exploited_by_malware": False,
            "exploited_by_nessus": False,
            "family": "CentOS Local Security Checks",
            "family_id": 38,
            "has_patch": True,
            "id": 125801,
            "in_the_news": False,
            "name": "CentOS 7 : bind (CESA-2019:1294)",
            "patch_publication_date": "2019-06-10T00:00:00Z",
            "modification_date": "2020-01-10T00:00:00Z",
            "publication_date": "2019-06-11T00:00:00Z",
            "risk_factor": "medium",
            "see_also": ["http://www.nessus.org/u?f35ea8cd"],
            "solution": "Update the affected bind packages.",
            "synopsis": "The remote CentOS host is missing one or more security updates.",
            "unsupported_by_vendor": False,
            "version": "1.5",
            "vuln_publication_date": "2019-10-09T00:00:00Z",
            "xrefs": [{"type": "CVE", "id": "2018-5743"}, {"type": "RHSA", "id": "2019:1294"}],
            "vpr": {
                "score": 3.6,
                "drivers": {
                    "age_of_vuln": {"lower_bound": 731},
                    "exploit_code_maturity": "UNPROVEN",
                    "cvss3_impact_score": 3.6,
                    "threat_intensity_last28": "VERY_LOW",
                    "threat_sources_last28": ["No recorded events"],
                    "product_coverage": "VERY_HIGH",
                },
                "updated": "2021-10-09T05:36:33Z",
            },
            "vpr_v2": {
                "score": 5.0,
                "vpr_percentile": 76.35,
                "vpr_severity": "MEDIUM",
                "exploit_probability": 0.002,
                "cve_id": "CVE-2018-5743",
                "exploit_code_maturity": "UNPROVEN",
                "on_cisa_kev": False,
                "in_the_news_intensity_last30": "VERY_LOW",
                "in_the_news_recency": "NO_RECORDED_EVENTS",
                "malware_observations_intensity_last30": "VERY_LOW",
                "malware_observations_recency": "NO_RECORDED_EVENTS",
            },
            "has_workaround": False,
            "cve": ["CVE-2018-5743"],
            "epss_score": 1.956,
            "type": "local",
        },
        "port": {"port": 0, "protocol": "TCP"},
        "scan": {
            "schedule_uuid": "1c12e931-8a64-443e-9b0e-382c1ea32b70",
            "started_at": "2025-08-26T14:34:38.571Z",
            "uuid": "3427421a-9476-e291-686f-8d60d7fc401892fd2478c88003fc",
            "target": "167.122.164.31",
        },
        "severity": "medium",
        "severity_id": 2,
        "severity_default_id": 2,
        "severity_modification_type": "NONE",
        "first_found": "2025-08-26T14:34:38.571Z",
        "last_found": "2025-08-26T14:34:38.571Z",
        "state": "OPEN",
        "indexed": "2025-08-26T14:35:07.817389Z",
        "source": "NESSUS",
        "finding_id": "0033592c-92f4-551c-bfc9-08490b970dc6",
    }


@pytest.fixture
def tenable_asset_connector(symphony_storage):
    module = TenableModule()
    module.configuration = {
        "base_url": "https://example.com",
        "access_key": "fake_tenable_access_token",
        "secret_key": "fake_tenable_secret_key",
    }

    test_tenable_asset_connector = TenableAssetConnector(module=module, data_path=symphony_storage)
    test_tenable_asset_connector.configuration = {
        "sekoia_base_url": "https://sekoia.io",
        "sekoia_api_key": "fake_api_key",
        "frequency": 60,
    }

    test_tenable_asset_connector.log = Mock()
    test_tenable_asset_connector.log_exception = Mock()

    yield test_tenable_asset_connector


def test_states_property(tenable_asset_connector):
    expected = [state.value for state in VulnerabilityState]
    assert tenable_asset_connector.states == expected
    assert type(tenable_asset_connector.severities[0]) == str


def test_severities_property(tenable_asset_connector):
    expected = [severity.value for severity in VulnerabilitySeverity]
    assert tenable_asset_connector.severities == expected
    assert type(tenable_asset_connector.severities[0]) == str


def test_extract_timestamp(tenable_asset_connector):
    vuln = {"first_found": "2024-06-01T12:00:00Z"}
    ts = tenable_asset_connector.extract_timestamp(vuln)
    assert isinstance(ts, int)
    assert ts == 1717243200


def test_extract_timestamp_last_found_field(tenable_asset_connector):
    vuln = {"last_found": "2024-06-01T12:00:00Z", "first_found": "2024-05-01T12:00:00Z"}
    ts = tenable_asset_connector.extract_timestamp(vuln, field="last_found")
    assert isinstance(ts, int)
    assert ts == 1717243200


def test_extract_timestamp_missing_field(tenable_asset_connector):
    vuln = {"last_found": "2024-06-01T12:00:00Z"}
    ts = tenable_asset_connector.extract_timestamp(vuln, field="first_found")
    assert isinstance(ts, int)
    tenable_asset_connector.log.assert_called()


def test_extract_timestamp_invalid_format(tenable_asset_connector):
    vuln = {"first_found": "invalid-date"}
    ts = tenable_asset_connector.extract_timestamp(vuln)
    assert isinstance(ts, int)
    tenable_asset_connector.log.assert_called()


def test_handle_activity(tenable_asset_connector):
    assert tenable_asset_connector.handle_activity("OPEN") == (1, "Create")
    assert tenable_asset_connector.handle_activity("FIXED") == (3, "Close")
    assert tenable_asset_connector.handle_activity("UNKNOWN") == (None, None)


def test_handle_activity_reopened(tenable_asset_connector):
    assert tenable_asset_connector.handle_activity("REOPENED") == (2, "Updated")


def test_extract_cvss_info_both_versions(tenable_asset_connector):
    plugin = {"cvss_base_score": 4.3, "cvss3_base_score": 7.5}
    cvss_list = tenable_asset_connector._extract_cvss_info(plugin)

    assert cvss_list is not None
    assert len(cvss_list) == 2
    assert cvss_list[0].version == "2.0"
    assert cvss_list[0].base_score == 4.3
    assert cvss_list[1].version == "3.0"
    assert cvss_list[1].base_score == 7.5


def test_extract_cvss_info_only_v2(tenable_asset_connector):
    plugin = {"cvss_base_score": 5.0}
    cvss_list = tenable_asset_connector._extract_cvss_info(plugin)

    assert cvss_list is not None
    assert len(cvss_list) == 1
    assert cvss_list[0].version == "2.0"


def test_extract_cvss_info_only_v3(tenable_asset_connector):
    plugin = {"cvss3_base_score": 8.5}
    cvss_list = tenable_asset_connector._extract_cvss_info(plugin)

    assert cvss_list is not None
    assert len(cvss_list) == 1
    assert cvss_list[0].version == "3.0"


def test_extract_cvss_info_none(tenable_asset_connector):
    plugin = {}
    cvss_list = tenable_asset_connector._extract_cvss_info(plugin)
    assert cvss_list is None


def test_parse_datetime_to_timestamp_valid(tenable_asset_connector):
    result = tenable_asset_connector._parse_datetime_to_timestamp("2025-08-26T14:34:38.571Z")
    assert isinstance(result, int)
    assert result > 0


def test_parse_datetime_to_timestamp_none(tenable_asset_connector):
    result = tenable_asset_connector._parse_datetime_to_timestamp(None)
    assert result is None


def test_parse_datetime_to_timestamp_invalid(tenable_asset_connector):
    result = tenable_asset_connector._parse_datetime_to_timestamp("not-a-date")
    assert result is None
    tenable_asset_connector.log.assert_called()


def test_map_os_type_windows(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("Windows 10 Pro")
    assert os_type_str == OSTypeStr.WINDOWS
    assert os_type_id == OSTypeId.WINDOWS


def test_map_os_type_linux(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("CentOS Linux release 7.9")
    assert os_type_str == OSTypeStr.LINUX
    assert os_type_id == OSTypeId.LINUX


def test_map_os_type_android(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("Android 12")
    assert os_type_str == OSTypeStr.ANDROID
    assert os_type_id == OSTypeId.ANDROID


def test_map_os_type_macos(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("macOS Ventura")
    assert os_type_str == OSTypeStr.MACOS
    assert os_type_id == OSTypeId.MACOS


def test_map_os_type_ios(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("iOS 16.5")
    assert os_type_str == OSTypeStr.IOS
    assert os_type_id == OSTypeId.IOS


def test_map_os_type_solaris(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("Solaris 10 (sparc)")
    assert os_type_str == OSTypeStr.SOLARIS
    assert os_type_id == OSTypeId.SOLARIS


def test_map_os_type_aix(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("AIX 7.2")
    assert os_type_str == OSTypeStr.AIX
    assert os_type_id == OSTypeId.AIX


def test_map_os_type_hpux(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("HP-UX 11i v3")
    assert os_type_str == OSTypeStr.HPUX
    assert os_type_id == OSTypeId.HPUX


def test_map_os_type_unknown(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type(None)
    assert os_type_str == OSTypeStr.UNKNOWN
    assert os_type_id == OSTypeId.UNKNOWN


def test_map_os_type_other(tenable_asset_connector):
    os_type_str, os_type_id = tenable_asset_connector._map_os_type("FreeBSD 13.1")
    assert os_type_str == OSTypeStr.OTHER
    assert os_type_id == OSTypeId.OTHER


def test_map_device_type_server(tenable_asset_connector):
    device_type_str, device_type_id = tenable_asset_connector._map_device_type("general-purpose")
    assert device_type_str == DeviceTypeStr.SERVER
    assert device_type_id == DeviceTypeId.SERVER


def test_map_device_type_desktop(tenable_asset_connector):
    device_type_str, device_type_id = tenable_asset_connector._map_device_type("desktop")
    assert device_type_str == DeviceTypeStr.DESKTOP
    assert device_type_id == DeviceTypeId.DESKTOP


def test_map_device_type_laptop(tenable_asset_connector):
    device_type_str, device_type_id = tenable_asset_connector._map_device_type("laptop")
    assert device_type_str == DeviceTypeStr.LAPTOP
    assert device_type_id == DeviceTypeId.LAPTOP


def test_map_device_type_router(tenable_asset_connector):
    device_type_str, device_type_id = tenable_asset_connector._map_device_type("router")
    assert device_type_str == DeviceTypeStr.ROUTER
    assert device_type_id == DeviceTypeId.ROUTER


def test_map_device_type_firewall(tenable_asset_connector):
    device_type_str, device_type_id = tenable_asset_connector._map_device_type("firewall")
    assert device_type_str == DeviceTypeStr.FIREWALL
    assert device_type_id == DeviceTypeId.FIREWALL


def test_map_device_type_unknown(tenable_asset_connector):
    device_type_str, device_type_id = tenable_asset_connector._map_device_type(None)
    assert device_type_str == DeviceTypeStr.UNKNOWN
    assert device_type_id == DeviceTypeId.UNKNOWN


def test_build_network_interfaces_wired(tenable_asset_connector):
    interfaces_data = [
        {
            "name": "eth0",
            "ipv4": ["192.168.1.10"],
            "ipv6": [],
            "mac_address": ["00:11:22:33:44:55"],
            "fqdn": ["host.example.com"],
            "virtual": False,
        }
    ]

    interfaces = tenable_asset_connector._build_network_interfaces(interfaces_data)

    assert len(interfaces) == 1
    assert interfaces[0].type == NetworkInterfaceTypeStr.WIRED
    assert interfaces[0].type_id == NetworkInterfaceTypeId.WIRED
    assert interfaces[0].ip == "192.168.1.10"
    assert interfaces[0].mac == "00:11:22:33:44:55"


def test_build_network_interfaces_wireless(tenable_asset_connector):
    interfaces_data = [{"name": "wlan0", "virtual": False}]
    interfaces = tenable_asset_connector._build_network_interfaces(interfaces_data)

    assert len(interfaces) == 1
    assert interfaces[0].type == NetworkInterfaceTypeStr.WIRELESS
    assert interfaces[0].type_id == NetworkInterfaceTypeId.WIRELESS


def test_build_network_interfaces_tunnel(tenable_asset_connector):
    interfaces_data = [{"name": "tun0", "virtual": True}]
    interfaces = tenable_asset_connector._build_network_interfaces(interfaces_data)

    assert len(interfaces) == 1
    assert interfaces[0].type == NetworkInterfaceTypeStr.TUNNEL
    assert interfaces[0].type_id == NetworkInterfaceTypeId.TUNNEL


def test_build_network_interfaces_mobile(tenable_asset_connector):
    interfaces_data = [{"name": "mobile_test", "virtual": False}]
    interfaces = tenable_asset_connector._build_network_interfaces(interfaces_data)

    assert len(interfaces) == 1
    assert interfaces[0].type == NetworkInterfaceTypeStr.MOBILE
    assert interfaces[0].type_id == NetworkInterfaceTypeId.MOBILE


def test_build_network_interfaces_empty(tenable_asset_connector):
    interfaces = tenable_asset_connector._build_network_interfaces([])
    assert interfaces == []


def test_build_network_interfaces_empty_data(tenable_asset_connector):
    interfaces = tenable_asset_connector._build_network_interfaces([])
    assert interfaces == []


def test_build_device_from_asset_complete(tenable_asset_connector, asset_info):
    device = tenable_asset_connector._build_device_from_asset(asset_info)

    assert device.uid == "74a507c2-c885-41ee-a34d-e151c99e3f60"
    assert device.hostname == "moxptgljp3d450f5.example.demo"
    assert device.type == DeviceTypeStr.SERVER
    assert device.type_id == DeviceTypeId.SERVER
    assert device.os.type == OSTypeStr.SOLARIS
    assert device.os.type_id == OSTypeId.SOLARIS
    assert device.is_managed is False
    assert device.ip == "97.195.198.2"


def test_build_device_from_asset_minimal(tenable_asset_connector):
    minimal_asset = {
        "id": "test-123",
        "system_type": [],
        "operating_system": [],
        "interfaces": [],
    }

    device = tenable_asset_connector._build_device_from_asset(minimal_asset)

    assert device.uid == "test-123"
    assert device.hostname == "unknown"
    assert device.type == DeviceTypeStr.UNKNOWN


def test_map_vulnerability_fields(tenable_asset_connector, asset_info, vulnerability):
    result = tenable_asset_connector.map_vulnerability_fields(vulnerability, asset_info)

    # Test static fields
    assert result.category_name == "Findings"
    assert result.category_uid == 2
    assert result.class_name == "Vulnerability Finding"

    # Test dynamic fields
    assert result.finding_info.uid == vulnerability["finding_id"]
    assert result.finding_info.title == vulnerability["plugin"]["name"]
    assert result.finding_info.desc == vulnerability["plugin"]["synopsis"]
    assert result.vulnerabilities.references[0] == vulnerability["plugin"]["see_also"][0]


def test_map_vulnerability_fields_with_confidence_high(tenable_asset_connector, vulnerability, asset_info):
    vulnerability["plugin"]["vpr_v2"]["score"] = 8.5
    result = tenable_asset_connector.map_vulnerability_fields(vulnerability, asset_info)

    assert result.confidence == "High"
    assert result.confidence_id == 3


def test_map_vulnerability_fields_with_confidence_low(tenable_asset_connector, vulnerability, asset_info):
    vulnerability["plugin"]["vpr_v2"]["score"] = 2.0
    result = tenable_asset_connector.map_vulnerability_fields(vulnerability, asset_info)

    assert result.confidence == "Low"
    assert result.confidence_id == 1


def test_map_vulnerability_fields_no_confidence(tenable_asset_connector, vulnerability, asset_info):
    vulnerability["plugin"]["vpr_v2"] = {}
    result = tenable_asset_connector.map_vulnerability_fields(vulnerability, asset_info)

    assert result.confidence is None
    assert result.confidence_id is None


def test_get_asset_info_success(tenable_asset_connector, asset_info):
    with patch("tenable_conn.asset_connector.vulnerability_asset.TenableIO") as mock_tenable:
        mock_tenable.return_value.assets.details.return_value = asset_info
        tenable_asset_connector._client = None
        result = tenable_asset_connector._get_asset_info("74a507c2-c885-41ee-a34d-e151c99e3f60")

    assert result == asset_info


def test_get_asset_info_exception(tenable_asset_connector):
    with patch.object(tenable_asset_connector.client.assets, "details", side_effect=Exception("API Error")):
        result = tenable_asset_connector._get_asset_info("test-uuid")

    assert result is None
    tenable_asset_connector.log.assert_called()


def test_update_checkpoint_success(tenable_asset_connector):
    tenable_asset_connector._latest_time = 1735217678
    tenable_asset_connector.update_checkpoint()

    assert tenable_asset_connector.from_date == 1735217678


def test_update_checkpoint_exception(tenable_asset_connector):
    tenable_asset_connector.cursor = None
    tenable_asset_connector.update_checkpoint()

    tenable_asset_connector.log_exception.assert_called()


def test_get_vulnerabilities(tenable_asset_connector, vulnerability, asset_info):
    with patch.object(ExportsAPI, "vulns", return_value=[vulnerability]):
        with patch.object(tenable_asset_connector, "_get_asset_info", return_value=asset_info):
            results = list(tenable_asset_connector._get_tenable_vul())

    assert len(results) == 1
    assert isinstance(results[0], VulnerabilityOCSFModel)


def test_get_vulnerabilities_no_results(tenable_asset_connector):
    with patch.object(ExportsAPI, "vulns", return_value=[]):
        results = list(tenable_asset_connector._get_tenable_vul())

    assert len(results) == 0


def test_get_vulnerabilities_exception(tenable_asset_connector):
    with patch.object(ExportsAPI, "vulns", side_effect=Exception("API Error")):
        list(tenable_asset_connector._get_tenable_vul())

    tenable_asset_connector.log_exception.assert_called()


def test_get_vulnerabilities_missing_asset_uuid(tenable_asset_connector):
    vuln_without_uuid = {"finding_id": "test-123", "asset": {}}

    with patch.object(ExportsAPI, "vulns", return_value=[vuln_without_uuid]):
        results = list(tenable_asset_connector._get_tenable_vul())

    assert len(results) == 0


def test_get_assets_success(tenable_asset_connector, vulnerability, asset_info):
    with patch.object(ExportsAPI, "vulns", return_value=[vulnerability]):
        with patch.object(tenable_asset_connector, "_get_asset_info", return_value=asset_info):
            results = list(tenable_asset_connector.get_assets())

    assert len(results) == 1
    assert isinstance(results[0], VulnerabilityOCSFModel)


def test_get_assets_exception(tenable_asset_connector):
    with patch.object(ExportsAPI, "vulns", side_effect=Exception("Critical Error")):
        list(tenable_asset_connector.get_assets())

    tenable_asset_connector.log_exception.assert_called()


def test_client_property_exception(tenable_asset_connector):
    with patch("tenable_conn.asset_connector.vulnerability_asset.TenableIO") as mock_tenable_io:
        mock_tenable_io.side_effect = Exception("Connection failed")
        tenable_asset_connector._client = None

        with pytest.raises(Exception):
            _ = tenable_asset_connector.client

        tenable_asset_connector.log_exception.assert_called()
