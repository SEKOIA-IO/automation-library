from unittest.mock import patch, MagicMock, PropertyMock
import vt
from googlethreatintelligence.get_vulnerability_report import GTIGetVulnerabilityReport
import socket  # Simulate timeout

# === Constants ===
API_KEY = "FAKE_API_KEY"
CVE_ID = "CVE-2021-34527"


@patch("googlethreatintelligence.get_vulnerability_report.vt.Client")
def test_get_vulnerability_report_success(mock_vt_client):
    """Test successful retrieval of vulnerability report"""

    # Arrange
    # Create a simple object that mimics the VT vulnerability object
    class MockCVSS:
        def __init__(self):
            self.score = 8.8
            self.severity = "HIGH"
            self.version = "3.1"

    class MockCounters:
        def __init__(self):
            self.iocs = 5
            self.files = 10
            self.domains = 2
            self.ip_addresses = 3

    class MockVulnerability:
        """Mock VT vulnerability object with real __dict__"""

        def __init__(self):
            self.id = "vuln123"
            self.title = "PrintNightmare"
            self.description = "Remote code execution vulnerability in Windows Print Spooler"
            self.cvss = MockCVSS()
            self.counters = MockCounters()

    mock_vuln = MockVulnerability()

    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance
    mock_client_instance.get_object.return_value = mock_vuln

    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    # Act
    response = action.run({"cve": CVE_ID})

    # Assert
    assert response["success"] is True
    assert response["data"]["cve"] == CVE_ID
    assert response["data"]["title"] == "PrintNightmare"
    assert response["data"]["cvss"]["severity"] == "HIGH"
    assert response["data"]["cvss"]["score"] == 8.8
    # Verify counters are present
    assert "counters" in response["data"]
    assert response["data"]["counters"]["iocs"] == 5
    assert response["data"]["counters"]["files"] == 10
    mock_vt_client.assert_called_once_with(API_KEY, trust_env=True, timeout=30.0)
    mock_client_instance.get_object.assert_called_once_with(f"/collections/vulnerability--{CVE_ID}")


@patch("googlethreatintelligence.get_vulnerability_report.vt.Client")
def test_get_vulnerability_report_fail_api(mock_vt_client):
    """Test behavior when VirusTotal API raises an exception"""
    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance

    # Simulate APIError
    mock_client_instance.get_object.side_effect = vt.APIError("WrongCredentialsError", "Invalid API key")

    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    response = action.run({"cve": CVE_ID})

    assert response["success"] is False
    assert "Invalid API key" in response["error"]
    mock_vt_client.assert_called_once_with(API_KEY, trust_env=True, timeout=30.0)
    mock_client_instance.get_object.assert_called_once_with(f"/collections/vulnerability--{CVE_ID}")


def test_get_vulnerability_report_no_api_key():
    """Test behavior when API key is missing"""
    action = GTIGetVulnerabilityReport()
    with patch.object(type(action.module), "configuration", new_callable=PropertyMock) as mock_config:
        mock_config.return_value = {}
        response = action.run({"cve": CVE_ID})

    assert response["success"] is False
    assert "API key" in response["error"]


def test_get_vulnerability_report_no_cve():
    """Test behavior when CVE ID is missing"""
    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    response = action.run({})  # No CVE

    assert response["success"] is False
    assert "CVE" in response["error"]


@patch("googlethreatintelligence.get_vulnerability_report.vt.Client")
def test_get_vulnerability_report_timeout(mock_vt_client):
    """Test behavior when request times out"""
    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance

    mock_client_instance.get_object.side_effect = socket.timeout("Request timed out")

    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    response = action.run({"cve": CVE_ID})

    assert response["success"] is False
    assert "timeout" in response["error"].lower()
    mock_vt_client.assert_called_once_with(API_KEY, trust_env=True, timeout=30.0)
