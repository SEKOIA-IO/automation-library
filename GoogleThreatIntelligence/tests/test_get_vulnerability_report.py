from unittest.mock import patch, MagicMock, PropertyMock
import vt
from googlethreatintelligence.get_vulnerability_report import GTIGetVulnerabilityReport

# === Test constants ===
API_KEY = "FAKE_API_KEY"
CVE_ID = "CVE-2021-34527"


@patch("googlethreatintelligence.get_vulnerability_report.vt.Client")
def test_get_vulnerability_report_success(mock_vt_client):
    """Test successful retrieval of vulnerability report"""
    # --- Arrange ---
    # Mocked vulnerability object returned by the VTAPIConnector
    mock_vuln = MagicMock()
    mock_vuln.id = "vuln123"
    mock_vuln.title = "PrintNightmare"
    mock_vuln.description = "Remote code execution vulnerability in Windows Print Spooler"
    mock_vuln.cvss = {"score": 8.8, "severity": "HIGH"}

    # Mock vt.Client context manager behavior
    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance

    # Simulate get_object() returning our fake vulnerability
    mock_client_instance.get_object.return_value = mock_vuln

    # Instantiate action and configure API key
    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    # --- Act ---
    response = action.run({"cve": CVE_ID})

    # --- Assert ---
    assert response is not None
    assert isinstance(response, dict)
    assert response.get("success") is True
    assert "data" in response
    assert response["data"]["cve"] == CVE_ID
    assert response["data"]["title"] == "PrintNightmare"
    assert response["data"]["cvss"]["severity"] == "HIGH"

    # Verify vt.Client called correctly
    mock_vt_client.assert_called_once_with(API_KEY)

    # Ensure proper API path was requested
    mock_client_instance.get_object.assert_called_once_with(
        f"/intelligence/vulnerability_collections/{CVE_ID}"
    )


@patch("googlethreatintelligence.get_vulnerability_report.vt.Client")
def test_get_vulnerability_report_fail_api(mock_vt_client):
    """Test error handling when VirusTotal API raises an exception"""
    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance

    # Simulate APIError on get_object()
    mock_client_instance.get_object.side_effect = vt.APIError("WrongCredentialsError", "Invalid API key")

    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    response = action.run({"cve": CVE_ID})

    assert response is not None
    assert isinstance(response, dict)
    assert response.get("success") is False
    assert "error" in response
    assert "Invalid API key" in response["error"]

    mock_vt_client.assert_called_once_with(API_KEY)
    mock_client_instance.get_object.assert_called_once_with(
        f"/intelligence/vulnerability_collections/{CVE_ID}"
    )


def test_get_vulnerability_report_no_api_key():
    """Test behavior when API key is missing"""
    action = GTIGetVulnerabilityReport()

    with patch.object(type(action.module), "configuration", new_callable=PropertyMock) as mock_config:
        mock_config.return_value = {}

        response = action.run({"cve": CVE_ID})

        assert response is not None
        assert isinstance(response, dict)
        assert response.get("success") is False
        assert "API key" in response.get("error", "")


def test_get_vulnerability_report_no_cve():
    """Test behavior when CVE ID is missing"""
    action = GTIGetVulnerabilityReport()
    action.module.configuration = {"api_key": API_KEY}

    response = action.run({})  # No CVE provided

    assert response is not None
    assert isinstance(response, dict)
    assert response.get("success") is False
    assert "CVE" in response.get("error", "")
