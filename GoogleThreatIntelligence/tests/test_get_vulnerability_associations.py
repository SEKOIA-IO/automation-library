# tests/test_get_vulnerability_associations.py

from unittest.mock import patch, MagicMock, PropertyMock
from googlethreatintelligence.get_vulnerability_associations import GTIGetVulnerabilityAssociations
import vt

# === Test constants ===
API_KEY = "FAKE_API_KEY"
IP = "8.8.8.8"


@patch("googlethreatintelligence.get_vulnerability_associations.vt.Client")
@patch("googlethreatintelligence.get_vulnerability_associations.VTAPIConnector")
def test_get_vulnerability_associations_success(mock_connector_class, mock_vt_client):
    """Test successful retrieval of vulnerability associations"""
    # Mock VTAPIConnector instance and its behavior
    mock_connector = MagicMock()
    mock_connector.results = [
        MagicMock(
            status="SUCCESS",
            response={
                "vulnerabilities_count": 2,
                "unique_cves_count": 2,
                "high_severity_count": 1,
                "cve_ids": ["CVE-2024-0001", "CVE-2024-0002"],
                "vulnerabilities": [
                    {"id": "1", "cve_id": "CVE-2024-0001", "cvss_severity": "HIGH"},
                    {"id": "2", "cve_id": "CVE-2024-0002", "cvss_severity": "MEDIUM"},
                ],
            },
        )
    ]
    mock_connector_class.return_value = mock_connector

    # Mock vt.Client context manager
    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance

    # Setup action
    action = GTIGetVulnerabilityAssociations()
    action.module.configuration = {"api_key": API_KEY}

    # Run the action
    response = action.run({"ip": IP})

    # === Assertions ===
    assert response is not None
    assert isinstance(response, dict)
    assert response["success"] is True
    assert "data" in response

    # Validate the structure of the returned data
    assert response["data"]["vulnerabilities_count"] == 2
    assert response["data"]["unique_cves_count"] == 2
    assert len(response["data"]["vulnerabilities"]) == 2

    # Ensure the mocks were called properly
    mock_vt_client.assert_called_once_with(API_KEY, trust_env=True)
    mock_connector_class.assert_called_once_with(API_KEY, ip=IP, domain="", url="", file_hash="")
    mock_connector.get_vulnerability_associations.assert_called_once_with(mock_client_instance)


@patch("googlethreatintelligence.get_vulnerability_associations.vt.Client")
@patch("googlethreatintelligence.get_vulnerability_associations.VTAPIConnector")
def test_get_vulnerability_associations_fail(mock_connector_class, mock_vt_client):
    """Test handling of APIError during vulnerability association retrieval"""
    # Mock VTAPIConnector instance
    mock_connector = MagicMock()
    mock_connector.get_vulnerability_associations.side_effect = vt.APIError("WrongCredentialsError", "Invalid API key")
    mock_connector_class.return_value = mock_connector

    # Mock vt.Client context manager
    mock_client_instance = MagicMock()
    mock_vt_client.return_value.__enter__.return_value = mock_client_instance

    # Setup action
    action = GTIGetVulnerabilityAssociations()
    action.module.configuration = {"api_key": API_KEY}

    # Run the action (should trigger exception)
    response = action.run({"ip": IP})

    # === Assertions ===
    assert response is not None
    assert isinstance(response, dict)
    assert response["success"] is False
    assert "error" in response
    assert "Invalid API key" in response["error"]

    # Ensure mocks were called
    mock_vt_client.assert_called_once_with(API_KEY, trust_env=True)
    mock_connector_class.assert_called_once_with(API_KEY, ip=IP, domain="", url="", file_hash="")
    mock_connector.get_vulnerability_associations.assert_called_once_with(mock_client_instance)


def test_get_vulnerability_associations_no_api_key():
    """Test handling of missing API key"""
    action = GTIGetVulnerabilityAssociations()

    # Patch the configuration property to return an empty dict
    with patch.object(type(action.module), "configuration", new_callable=PropertyMock) as mock_config:
        mock_config.return_value = {}

        response = action.run({"ip": IP})

        assert response is not None
        assert isinstance(response, dict)
        assert response["success"] is False
        assert "API key not configured" in response.get("error", "")
