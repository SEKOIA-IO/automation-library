"""
Sekoia Automation Action: Get Vulnerability Associations from Google Threat Intelligence
"""
from sekoia_automation.action import Action
from .client import VTAPIConnector
import vt


class GTIGetVulnerabilityAssociations(Action):
    """
    Retrieve vulnerabilities linked to an IP or domain
    """

    def run(self, arguments: dict):
        api_key = self.module.configuration.get("api_key")
        if not api_key:
            return {"success": False, "error": "API key not configured"}
        #TODO: Check README about parameters -> needs to be domain or ip, fix client.py accordingly
        #entity_type = arguments.get("entity_type", "domains")
        ip = arguments.get("ip", "")

        try:
            connector = VTAPIConnector(api_key, ip=ip, domain="", url="", file_hash="")
            with vt.Client(api_key) as client:
                connector.get_vulnerability_associations(client)
                result = connector.results[-1]

            return {
                "success": result.status == "SUCCESS",
                "data": result.response
            }

        except Exception as e:
            return {"success": False, "error": str(e)}
