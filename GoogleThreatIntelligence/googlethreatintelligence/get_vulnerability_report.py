"""
Sekoia Automation Action for Google Threat Intelligence: Get Vulnerability Report
"""

from sekoia_automation.action import Action
from .client import VTAPIConnector
import vt


class GTIGetVulnerabilityReport(Action):
    """
    Retrieve CVE vulnerability report from Google Threat Intelligence
    """

    def run(self, arguments: dict):
        try:
            api_key = self.module.configuration.get("api_key")
            if not api_key:
                return {"success": False, "error": "API key not configured"}
            cve = arguments.get("cve")
            if not cve:
                return {"success": False, "error": "No CVE provided"}

            connector = VTAPIConnector(api_key, cve=cve, domain="", ip="", url="", file_hash="")
            # Add explicit timeout to prevent infinite loops (30 seconds)
            with vt.Client(api_key, trust_env=True, timeout=30.0) as client:
                connector.get_vulnerability_report(client)

                # Check if we have results
                if not connector.results:
                    return {"success": False, "error": "No results returned from API"}

                result = connector.results[-1]

            return {"success": result.status == "SUCCESS", "data": result.response, "error": result.error}

        except vt.APIError as e:
            # Handle VT API specific errors
            return {"success": False, "error": f"VirusTotal API Error: {str(e)}"}
        except TimeoutError as e:
            # Handle timeout errors explicitly
            return {"success": False, "error": f"Request timeout: {str(e)}"}
        except Exception as e:
            return {"success": False, "error": str(e)}
